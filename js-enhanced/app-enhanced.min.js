/*
 Ottawa Dog Park Finder
 @author: Thomas J Bradley <theman@thomasjbradley.ca>
 @link: http://thomasjbradley.ca
 @copyright: Copyright MMXI, Thomas J Bradley (http://thomasjbradley.ca)
*/
function objlength(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}
var ParkFinder={map:null,maxParks:10,navgeo:null,usergeo:null,parkTemplate:null,parkLoader:'<div id="parksloader" role="status">{{l.loading}}</div>',init:function(a){ParkFinder.map=a;$("#map").attr("tabindex",-1).attr("aria-live","polite");ParkFinder.initGeoLoc();ParkFinder.initLocForm();ParkFinder.initParkLists();ParkFinder.initRatings();navigator.onLine&&window.applicationCache&&window.applicationCache.status!==window.applicationCache.UNCACHED&&setTimeout(ParkFinder.updateParks,6E3);ParkFinder.map.initMarkers();
ParkFinder.parkTemplate=$("#popular ol li:first-child").eq(0).clone();ParkFinder.updateParkList("clean",ParkFinder.map.sortParksOn("cleanlinessBayesian"))},initGeoLoc:function(){if(geo_position_js.init())geo_position_js.getCurrentPosition(function(a){ParkFinder.navgeo=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);ParkFinder.setUpGeoButton()},function(){});else ParkFinder.navgeo=new google.maps.LatLng(ParkFinder.map.params.center.lat(),ParkFinder.map.params.center.lng())},initLocForm:function(){$("#locform").submit(function(){ParkFinder.setUserLocation($("#loc").val(),
ParkFinder.navgeo);return false});$("#loc").focus(function(){$("label.loc").hide()});$("#loc").blur(function(){$("#loc").val()===""&&$("label.loc").show()});$("#loc").val()!==""&&$("label.loc").hide()},initParkLists:function(){$(".parklists").delegate("ol li .rate","click",function(){ParkFinder.displayRateScreen($(this).parent().attr("data-guid"));return false});$(".parklists").delegate("ol li .parkinfo","click",function(){window.scrollTo(0,0);ParkFinder.map.displayInfoWindow($(this).parent().attr("data-guid"));
return false})},initRatings:function(){$(".ratewidget").css({top:-($(".ratewidget").outerHeight()+100)});$("#map").delegate(".info button","click",function(){ParkFinder.displayRateScreen($(this).attr("data-guid"));return false});$("#cancel-button").click(function(){ParkFinder.closeRateScreen();return false});$("#rate-button").click(function(){ParkFinder.closeRateScreen();ParkFinder.submitRating();return false});$("#rate-form").submit(function(){ParkFinder.closeRateScreen();ParkFinder.submitRating();
return false})},displayRateScreen:function(a){ParkFinder.map.closeInfoWindows();$("#rate-button").attr("disabled",false);$("#cancel-button").attr("disabled",false);var b=ParkFinder.map.getParkType(ParkFinder.map.parks[a]),c=$(".ratewidget");$('input[type="radio"]',c).attr("checked",false);$("h2",c).html(ParkFinder.map.parks[a].name);$("form",c).attr("data-guid",a);$("header em",c).removeClass().addClass(b).attr("title",ParkFinder.map.labels[b]).html(ParkFinder.map.labels[b]);window.scrollTo(0,0);
$(".ratebox").show().css({opacity:1});c.css({top:25});c.focus()},closeRateScreen:function(){$(".ratebox").css({opacity:0});$(".ratewidget").css({top:-($(".ratewidget").outerHeight()+100)});setTimeout(function(){$(".ratebox").hide()},500);$("#map").focus()},submitRating:function(){$("#rate-button").attr("disabled",true);$("#cancel-button").attr("disabled",true);var a=ParkFinder.getValidRatingData();$(".parks-group header").prepend(ParkFinder.parkLoader);$.ajax({url:"/parks/"+a.guid+"/rate",type:"post",
data:a,success:function(){$("#parksloader").remove()},error:function(){$("#parksloader").remove()}})},updateParks:function(){$(".parks-group header").prepend(ParkFinder.parkLoader);$.ajax({url:"/parks.js?"+(new Date).getTime(),success:function(){$("#parksloader").remove();ParkFinder.updateParkList("popular",ParkFinder.map.sortParksOn("overallBayesian"));ParkFinder.updateParkList("friendly",ParkFinder.map.sortParksOn("friendlinessBayesian"));ParkFinder.updateParkList("clean",ParkFinder.map.sortParksOn("cleanlinessBayesian"))},
error:function(){$("#parksloader").remove()}})},getValidRatingData:function(){var a=parseInt($('input[name="facility"]:checked').val(),10),b=parseInt($('input[name="friendly"]:checked').val(),10),c=parseInt($('input[name="clean"]:checked').val(),10);if(a<0)a=0;if(a>2)a=2;if(b<0)b=0;if(b>2)b=2;if(c<0)c=0;if(c>2)c=2;return{guid:$("#rate-form").attr("data-guid"),facility:a,friendly:b,clean:c}},updateParkList:function(a,b,c){var d="%",f=0,h=b.length>ParkFinder.maxParks?ParkFinder.maxParks:b.length;if(typeof c!=
"undefined"){if(c.hasOwnProperty("symbol"))d=c.symbol;if(c.hasOwnProperty("precision"))f=c.precision}c=$('<ol class="parks"></ol>');for(var g=0;g<h;g++){var i=b[g][0],k=ParkFinder.map.getParkType(ParkFinder.map.parks[i]),j=b[g][1].toString().split(/\./),e=ParkFinder.parkTemplate.clone();if(f>0){value=j[0];if(j[1]!="undefined")value+="."+j[1].slice(0,f)}else value=j[0];$(e).attr("data-guid",i).removeClass("first-child");g==0&&$(e).addClass("first-child");$(".parkinfo",e).attr("href","/parks/"+i);$(".rategroup .value",
e).html(value);$(".rategroup .symbol",e).html(d);$(".name",e).html(ParkFinder.map.parks[i].name);$(".amount-votes .vote-total",e).html(ParkFinder.map.parks[i].amountVotes);$("em",e).removeClass().addClass("park-type").addClass(k).attr("title",ParkFinder.map.labels[k]).html(ParkFinder.map.labels[k]);c.append(e)}$("#"+a).html(c)},setUpGeoButton:function(){$("#locform").addClass("geo");$("#currentloc").removeClass("no-geo");addClass($id("locform"),"geo");$("#currentloc").click(function(){ParkFinder.usergeo=
ParkFinder.navgeo;ParkFinder.displayUserLocation();$("#map").focus();return false})},setUserLocation:function(a){var b=new google.maps.Geocoder;b&&b.geocode({address:a+ParkFinder.map.address,region:"{{l.region}}"},function(c,d){if(d==google.maps.GeocoderStatus.OK){ParkFinder.usergeo=c[0].geometry.location;ParkFinder.displayUserLocation()}})},displayUserLocation:function(){ParkFinder.map.setUserLocation(ParkFinder.usergeo);ParkFinder.displayNearby(ParkFinder.usergeo);ParkFinder.map.closeInfoWindows()},
displayNearby:function(a){a=ParkFinder.map.sortNearbyParks(a);$("#nearby").html()===""&&$("#nearby").html($("#popular").html());ParkFinder.updateParkList("nearby",a,{symbol:"km",precision:1});SimpleTabs.hide();$("#tablist-wrapper").removeClass("no-nearby");SimpleTabs.show("nearby")}},Map={id:"map",wrapper:"#map-wrapper",markersLoaderId:"markers-loader",map:null,markerManager:null,parkMarkers:{},openInfoWindows:[],userMarker:null,address:"{{l.adr_extra}}",params:{zoom:7,center:new google.maps.LatLng(parseFloat("{{l.geo_position_lat}}"),
parseFloat("{{l.geo_position_lng}}")),mapTypeId:google.maps.MapTypeId.ROADMAP},markers:{free:new google.maps.MarkerImage("/theme/img/icons-basic.png",new google.maps.Size(22,26),new google.maps.Point(183,19),new google.maps.Point(13,26)),no:new google.maps.MarkerImage("/theme/img/icons-basic.png",new google.maps.Size(22,26),new google.maps.Point(139,19),new google.maps.Point(13,26)),leashed:new google.maps.MarkerImage("/theme/img/icons-basic.png",new google.maps.Size(22,26),new google.maps.Point(205,
19),new google.maps.Point(13,26)),restrictions:new google.maps.MarkerImage("/theme/img/icons-basic.png",new google.maps.Size(22,26),new google.maps.Point(161,19),new google.maps.Point(13,26)),shadow:new google.maps.MarkerImage("/theme/img/icons-basic.png",new google.maps.Size(30,26),new google.maps.Point(88,19),new google.maps.Point(13,26)),user:new google.maps.MarkerImage("/theme/img/icons-basic.png",new google.maps.Size(22,26),new google.maps.Point(117,19),new google.maps.Point(13,26))},labels:{free:"{{l.dogs_free}}",
no:"{{l.dogs_no}}",leashed:"{{l.dogs_leashed}}",restrictions:"{{l.dogs_restricted}}",user:"{{l.user_location}}"},init:function(){Map.map=new google.maps.Map(document.getElementById(Map.id),Map.params);$(Map.wrapper).prepend('<div id="'+Map.markersLoaderId+'">{{l.mapping_parks}}</div>');google.maps.event.addListener(Map.map,"center_changed",function(){google.maps.event.trigger(Map.map,"dragend")})},initMarkers:function(){Map.createMarkers();Map.markerManager=new MarkerManager(Map.map);var a=google.maps.event.addListener(Map.markerManager,
"loaded",function(){google.maps.event.removeListener(a);Map.markerManager.addMarkers(Map.getMarkers(),3);Map.markerManager.refresh();$("#"+Map.markersLoaderId).remove()})},createMarkers:function(){for(var a in Map.parks)if(Map.parks.hasOwnProperty(a)){var b=Map.getParkType(Map.parks[a]);Map.parkMarkers[a]=new google.maps.Marker({position:new google.maps.LatLng(Map.parks[a].geolocation[0],Map.parks[a].geolocation[1]),icon:Map.getMarker(Map.parks[a]),shadow:Map.markers.shadow,title:Map.parks[a].name+
"; "+Map.labels[b]});Map.parkMarkers[a].guid=a;google.maps.event.addListener(Map.parkMarkers[a],"click",function(){Map.displayInfoWindow(this.guid)})}},getMarkers:function(){var a=[],b;for(b in Map.parkMarkers)Map.parkMarkers.hasOwnProperty(b)&&a.push(Map.parkMarkers[b]);return a},getParkType:function(a){if(!a.dogs)return"no";if(a.restrictions)return"restrictions";if(a.leashed)return"leashed";return"free"},getMarker:function(a){return Map.markers[Map.getParkType(a)]},displayInfoWindow:function(a){var b=
Map.getParkType(Map.parks[a]);Map.closeInfoWindows();Map.map.setCenter(Map.parkMarkers[a].getPosition());var c=$('<div class="info '+b+' map-info"></div>');c.append('<span class="icon" title="'+Map.labels[b]+'">'+Map.labels[b]+"</span>");c.append('<strong class="park-name">'+Map.parks[a].name+"</strong>");c.append('<p class="adr">'+Map.parks[a].address+"</p>");c.append('<p class="parktype">'+Map.labels[b]+"</p>");Map.parks[a].notes!==""&&c.append('<p class="notes">'+Map.parks[a].notes+"</p>");b=$('<ul class="rating"></ul>');
b.append('<li class="overall" title="{{l.rate_overall}}"><span class="value">'+Map.parks[a].overallBayesian+"</span>{{l.rate_percent}}</li>");b.append('<li class="facility"><span title="{{l.rate_facility}}" class="icon"></span><span class="value">'+Map.parks[a].facilityBayesian+"</span>{{l.rate_percent}}</li>");b.append('<li class="friendly"><span title="{{l.rate_friendly}}" class="icon"></span><span class="value">'+Map.parks[a].friendlinessBayesian+"</span>{{l.rate_percent}}</li>");b.append('<li class="clean"><span title="{{l.rate_clean}}" class="icon"></span><span class="value">'+
Map.parks[a].cleanlinessBayesian+"</span>{{l.rate_percent}}</li>");b.append('<li class="amount-ratings"><span class="value">'+Map.parks[a].amountVotes+"</span> {{l.ratings}}</li>");c.append(b);c.append('<div class="buttonbox"><button class="btn btn-alt" data-guid="'+a+'">{{l.rate}}</button></div>');c=new google.maps.InfoWindow({content:$("<div>").append(c).html(),maxWidth:350});c.open(Map.map,Map.parkMarkers[a]);Map.openInfoWindows.push(c)},closeInfoWindows:function(){for(var a=Map.openInfoWindows.length,
b=0;b<a;b++)Map.openInfoWindows[b].close();Map.openInfoWindows=[]},sortParksOn:function(a,b){var c=[];if(typeof b=="undefined")b=Map.parks;for(var d in b)Map.parks.hasOwnProperty(d)&&c.push([d,Map.parks[d][a]]);c.sort(function(f,h){return h[1]-f[1]});return c},sortNearbyParks:function(a,b){var c=[];if(typeof b=="undefined")b=Map.parks;for(var d in b)if(Map.parks.hasOwnProperty(d)){var f=new LatLon(a.lat(),a.lng());c.push([d,f.distanceTo(new LatLon(Map.parks[d].geolocation[0],Map.parks[d].geolocation[1]))])}c.sort(function(h,
g){return h[1]-g[1]});return c},setUserLocation:function(a){Map.userMarker!==null&&Map.userMarker.setMap(null);Map.userMarker=new google.maps.Marker({position:a,map:Map.map,icon:Map.markers.user,shadow:Map.markers.shadow,title:Map.labels.user});Map.map.setCenter(a)}};$.getScript("/parks.js",function(){ParkFinder.init(Map)});Map.init();
